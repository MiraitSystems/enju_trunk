<script>
jQuery(function(){
  new AutoKana('manifestation_original_title', 'manifestation_title_transcription', { katakana:true, toggle:false });

  var article_title = "<%= @manifestation.article_title %>"
  displayArticleTitle(article_title);
  $('#manifestation_manifestation_type_id').change(function () {
    article_title = ""
    displayArticleTitle(article_title);
  });
})

function displayArticleTitle(article_title) {
  var manifestation_type = $('#manifestation_manifestation_type_id').val();
  var series  = ['3', '4', '5', '6']; 
  var article = ['9', '10'];
  var pub_data_field = "<label class='pub_date' for='manifestation_pub_date'><%= t('activerecord.attributes.manifestation.pub_date')%></label>";

  if($.inArray(manifestation_type, article) != -1) {
    $("#article_title_field").show();
    pub_data_field = "<label class='pub_date' for='manifestation_pub_date'><%= t('activerecord.attributes.manifestation.pub_date_article')%></label>"
    $("#frequency_field").hide();
    $("#manifestation_frequency_id").val("17");
  } else if($.inArray(manifestation_type, series) != -1) {
    $("#frequency_field").show(); 
    $("#article_title_field").hide();
    $("#manifestation_article_title").val("");
  } else {
    $("#frequency_field").hide();
    $("#manifestation_frequency_id").val("17");
    $("#article_title_field").hide();
    $("#manifestation_article_title").val("");
  }
  $(".pub_date").html(pub_data_field);
}
$(document).keydown(function(e) {
  $("input[type=text]").keypress(function(ev) {
   if ((ev.which && ev.which === 13) ||
        (ev.keyCode && ev.keyCode === 13)) {
      return false;
    } else {
      return true;
    }
  });
});
</script>
<script id="script_theme">
  $(document).ready(function() { 
    $("#manifestation_theme").select2({
      multiple: true, 
      data: <%= raw @select_theme_tags.to_json -%>, 
      formatNoMatches: function(term) {
        return <%= raw t("page.theme.no_matches_found").to_json %>;
      },
      width: "300px",
    }); 
  });
</script>
<!-- TODO -->
<script>
  $(document).ready(function() { 
    $("#e10").select2({
      data: <%= raw @select_carrier_type_tags.to_json -%>, 
      matcher: function(term, text, opt) {
        return text.toUpperCase().indexOf(term.toUpperCase())>=0
            || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())>=0;
      }
    });
  });
</script>
<script>
  $(document).ready(function() { 
    $("#manifestation_carrier_type_id").select2({
      matcher: function(term, text, opt) {
        return text.toUpperCase().indexOf(term.toUpperCase())==0
            || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())==0;
      }
    });
  });
</script>
<script>
  $(document).ready(function() { 
    $("#e17_2").select2({
      matcher: function(term, text, opt) {
        return text.toUpperCase().indexOf(term.toUpperCase())==0
            || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())==0;
      }
    });
  });
</script>
<script id="script_patron">
  $(document).ready(function() {
    $("#patron_search_creator,#patron_search_contributor,#patron_search_publisher").select2({
      multiple: true,
      minimumInputLength: 1,
      width: "220px",
      placeholder: <%= raw t("patron.search_placeholder").to_json %>,
      formatNoMatches: function(term) {
        return "'" + term + "' " + <%= raw t("patron.search_nomatch").to_json %>;
      },
      formatSearching: function() {
        return <%= raw t("patron.search_searching").to_json %>;
      },
      formatInputTooShort: function(term, minLength){
        return <%= raw t("patron.search_placeholder").to_json %>;
      },
      ajax: {
        url: '<%= "http://" + request.host.to_s + ":" + request.port.to_s + "/patrons/search_name.json" %>',
        dataType: 'json',
        data: function (term, page) {
            return {search_phrase: term,
            };
        },
        results: function (data, page) {
            return {results: data};
        },
      },
      initSelection: function(element, callback) {
        var id=$(element).val();
        if (id!=="") {
            $.ajax('<%= "http://" + request.host.to_s + ":" + request.port.to_s + "/patrons/search_name.json" + "?patron_id=" %>' + id, {
                dataType: "json"
            }).done(function(data) { callback(data); });
        }
      },
    });
  });
</script>
<script id="script_add_patron">
  var ItemField_creator = {
   currentNumber : <%= raw @new_creator_number.to_json %>,
    itemTemplate : ''
     + '<input id="creator_full_name___count__" name="creator_full_name[__count__]" size="20" type="text">&#10'
     + '<input id="creator_full_name_transcription___count__" name="creator_full_name_transcription[__count__]" size="20" type="text">&#10'
     + '<select id="creator_type_id___count__" name="creator_type_id[__count__]">'
     + <%= raw @create_types.collect{|r| ["<option value='" + r.id.to_s + "'>" + r.display_name.localize + "</option>"]}.join().to_json %>
     + '</select>&#10',
   add : function () {
      var field = document.getElementById('SF' + this.currentNumber);
      var replaceCount = this.currentNumber;
      var newItem = this.itemTemplate.replace(/__count__/mg, replaceCount);
      field.innerHTML = newItem;
      var nextNumber = this.currentNumber + 1;
      var new_area = document.createElement("div");
      new_area.setAttribute("id", "SF" + nextNumber);
      new_area.setAttribute("class", "field");
      field.appendChild(new_area);
      this.currentNumber = nextNumber;
    },
    remove : function () {
      if ( this.currentNumber == 1) { return; }
      this.currentNumber--;
      var field = document.getElementById('SF' + this.currentNumber);
      field.removeChild(field.lastChild);
      field.innerHTML = '';
    }
  }
  var ItemField_contributor = {
   currentNumber : <%= raw @new_contributor_number.to_json %>,
    itemTemplate : ''
     + '<input id="contributor_full_name___count__" name="contributor_full_name[__count__]" size="20" type="text">&#10'
     + '<input id="contributor_full_name_transcription___count__" name="contributor_full_name_transcription[__count__]" size="20" type="text">&#10'
     + '<select id="contributor_type_id___count__" name="contributor_type_id[__count__]">'
     + <%= raw @realize_types.collect{|r| ["<option value='" + r.id.to_s + "'>" + r.display_name.localize + "</option>"]}.join().to_json %>
     + '</select>&#10',
   add : function () {
      var field = document.getElementById('TF' + this.currentNumber);
      var replaceCount = this.currentNumber;
      var newItem = this.itemTemplate.replace(/__count__/mg, replaceCount);
      field.innerHTML = newItem;
      var nextNumber = this.currentNumber + 1;
      var new_area = document.createElement("div");
      new_area.setAttribute("id", "TF" + nextNumber);
      new_area.setAttribute("class", "field");
      field.appendChild(new_area);
      this.currentNumber = nextNumber;
    },
    remove : function () {
      if ( this.currentNumber == 1) { return; }
      this.currentNumber--;
      var field = document.getElementById('TF' + this.currentNumber);
      field.removeChild(field.lastChild);
      field.innerHTML = '';
    }
  }
  var ItemField_publisher = {
   currentNumber : <%= raw @new_publisher_number.to_json %>,
    itemTemplate : ''
     + '<input id="publisher_full_name___count__" name="publisher_full_name[__count__]" size="20" type="text">&#10'
     + '<input id="publisher_full_name_transcription___count__" name="publisher_full_name_transcription[__count__]" size="20" type="text">&#10'
     + '<select id="publisher_type_id___count__" name="publisher_type_id[__count__]">'
     + <%= raw @produce_types.collect{|r| ["<option value='" + r.id.to_s + "'>" + r.display_name.localize + "</option>"]}.join().to_json %>
     + '</select>&#10',
   add : function () {
      var field = document.getElementById('UF' + this.currentNumber);
      var replaceCount = this.currentNumber;
      var newItem = this.itemTemplate.replace(/__count__/mg, replaceCount);
      field.innerHTML = newItem;
      var nextNumber = this.currentNumber + 1;
      var new_area = document.createElement("div");
      new_area.setAttribute("id", "UF" + nextNumber);
      new_area.setAttribute("class", "field");
      field.appendChild(new_area);
      this.currentNumber = nextNumber;
    },
    remove : function () {
      if ( this.currentNumber == 1) { return; }
      this.currentNumber--;
      var field = document.getElementById('UF' + this.currentNumber);
      field.removeChild(field.lastChild);
      field.innerHTML = '';
    }
  }
</script>
<script id="script_add_title">
  var ItemField_title = {
    currentNumber :<%= @count_titles-1 -%>,
    itemTemplate : ''
                 + '<input id="manifestation_title___count__" name="manifestation_title[__count__]"  placeholder=<%= t('activerecord.models.title') %> type="text" value="" class="resource_title" /> '
                 + '<select id="manifestation_work_has_titles_attributes___count___title_type_id" name="manifestation[work_has_titles_attributes][__count__][title_type_id]"> '

                 <% @title_types.collect do |m| %>
                   + '<option value="<%= m.id %>"><%= m.display_name %></option>'
                 <% end %>

                 + '<input id="manifestation_work_has_titles_attributes___count___title_id" name="manifestation[work_has_titles_attributes][__count__][title_id]" type="hidden" value="" /> ' 

                 + '<input id="manifestation_work_has_titles_attributes___count___title_id" name="manifestation[work_has_titles_attributes][__count__][position]" type="hidden" value="__count__" />'

                 + '<input type="button" value="+" onClick="ItemField_title.add();" />  '
                 + '<input type="button" value="-" onClick="ItemField_title.remove();" /> ',
    add : function () {

      this.currentNumber++;
      var field = document.getElementById('VF' + this.currentNumber);

      if (field.style.display == "none"){
        field.style.display = "block";
      }else{
        var replaceCount = this.currentNumber;
        var newItem = this.itemTemplate.replace(/__count__/mg, replaceCount);
        field.innerHTML = newItem;
        var nextNumber = this.currentNumber + 1;
        var new_area = document.createElement("div");
        new_area.setAttribute("id", "VF" + nextNumber);
        new_area.setAttribute("class", "field");
        field.appendChild(new_area);
      }
    },
    remove : function () {

      if ( this.currentNumber == 0) { return; }

      var field = document.getElementById('VF' + this.currentNumber);
      input_value = document.getElementById('manifestation_title_' + this.currentNumber);
      input_value.value = "";
      var select_state = document.getElementById('manifestation_work_has_titles_attributes_' + this.currentNumber + '_title_type_id').getElementsByTagName('option');
      select_state[0].selected = true;
      field.style.display="none";
      this.currentNumber--;

    }
  };
</script>



<%= render 'page/required_field' %>
<%= simple_form_for(@manifestation, :html => { :multipart => true }) do |f| -%>
  <%= f.error_messages -%>

  <div class="field">
    <%- if !@manifestation.new_record? and @manifestation.series_statement -%>
      <%= f.hidden_field :series_statement_id, :value => @manifestation.series_statement.id -%>
      <%= f.label t('activerecord.models.series_statement') -%>
      <%= link_to @manifestation.series_statement.original_title, @manifestation.series_statement -%>
      (<%= link_to t('series_statement.edit'), series_statements_path(:manifestation_id => @manifestation.id) -%>)
    <%- else -%>
      <%= f.hidden_field :series_statement_id, :value => @manifestation.series_statement.id if @manifestation.series_statement-%>
      <%= f.label t('activerecord.models.series_statement') -%>
      <%= link_to @manifestation.series_statement.original_title, @manifestation.series_statement if @manifestation.series_statement -%>
      <% if @manifestation.new_record? %>
        (<%= link_to t('page.listing', :model => t('activerecord.models.series_statement')), series_statements_path -%>)
      <% else %>
        (<%= link_to t('page.listing', :model => t('activerecord.models.series_statement')), manifestation_series_statements_path(@manifestation) -%>)
      <%- end -%>
    <%- end -%>
  </div>

  <div class="field">
    <%= f.label :original_title -%><br />
    <%= f.text_field :original_title, :class => 'resource_title' -%>
  </div>
  <div class="field">
    <%= f.label :title_transcription -%><br />
    <%= f.text_field :title_transcription, :class => 'resource_title' -%>
  </div>
  <div class="field">
    <%= f.label :title_alternative -%><br />
    <%= f.text_field :title_alternative, :class => 'resource_title' -%>
  </div>
  <div class="field" id="article_title_field">
    <%= f.label :article_title %><br />
    <%= f.text_field :article_title, :class => 'resource_title' %>
  </div>

  <% if SystemConfiguration.get('manifestation.use_titles') %>
    <div class="field">
      <% i = 0 %>
      <%= f.fields_for :work_has_titles, @manifestation.work_has_titles do |title| %>
        <div id="VF<%= i %>">
          <% if title.object.manifestation_title %>
            <%= text_field_tag "manifestation_title[#{i}]", title.object.manifestation_title.title, :placeholder => t('activerecord.models.title'), :class => 'resource_title' %>
          <% else %>
            <%= text_field_tag "manifestation_title[#{i}]", "", :placeholder => t('activerecord.models.title') %>
          <% end %>
          <%= title.select :title_type_id, @title_types.collect{|m| [m.display_name,m.id]}  %>
          <%= title.hidden_field :title_id  %>
          <%= title.hidden_field :position %>

          <%= button_to_function '+', 'ItemField_title.add()' -%>
          <%= button_to_function '-', 'ItemField_title.remove()' if i > 0 -%>
          <br />
        </div>
        <% i +=1  %>
      <% end %>

      <div id="VF<%= i %>" class="field">
      </div>
    </div>
  <% end %>

  <%= render 'form_patron_field' %>
  <div class="field">
    <%= f.label t('page.file') -%><br />
    <%= f.file_field :attachment -%>
    <% unless @manifestation.new_record? %>
      <%- unless @manifestation.attachment_file_name.blank? -%>
        <%= f.check_box :delete_attachment, :onClick => "toggle_upload()" -%><%= t('manifestation.delete_attachment') -%>
        <%= render 'manifestations/attachment_file', :manifestation => @manifestation -%>
      <%- end -%>
    <% end %>
  </div>

  <script type="text/javascript">
    function toggle_upload(){
      if ($('#manifestation_delete_attachment').attr('checked')){
        $('#manifestation_attachment').attr("disabled", true);
      } else {
        $('#manifest"tion_attachment').removeAttr("disabled");
      }
    }
  </script>

  <div class="field">
    <%= f.label t('activerecord.models.carrier_type') -%>
    <%= f.select(:carrier_type_id, @carrier_types.collect{|m| [m.display_name.localize, m.id]}) -%>
    <br>テストフォーム<br>
    <%= f.hidden_field(:carrier_type_id, :id => 'e10', :style => "width:200px") -%>
    <br>
    <%#= f.select(:carrier_type_id, :id => 'e17_2', :alt => @select_carrier_type_tags.collect{|m| [m.name]}, :value => @select_carrier_type_tags.collect{|m| [m.text.localize, m.id]}, :style => "width:200px") -%>
    <%= f.select(:carrier_type_id, @select_carrier_type_tags.collect{|m| [m.text, m.id]}, :alt => @select_carrier_type_tags.collect{|m| [m.alt]}, :style => "width:200px") -%>
    <%#= logger.error "############## #{@select_carrier_type_tags.collect{|m| [m.text, m.id, m.alt]}} ###############" -%>
    <br>
    <select id="e17_2" style="width:200px">
      <option alt="print", value="1">印刷物</option>
      <option alt="CD", value="2">CD</option>
      <option alt="DVD", value="3">DVD</option>
      <option alt="file", value="6">コンピュータファイル</option>
      <option alt="AV", value="4">視聴覚資料</option>
      <option alt="sheaf", value="5">加除式</option>
      <option alt="micro", value="7">マイクロ資料</option>
    </select>
    <!-- TODO: Formの切り替え時に入力項目をAjaxで書き換える -->
    <br>
  </div>
  <div class="field">
    <%= f.label t('activerecord.models.manifestation_type') -%>
    <%= f.select(:manifestation_type_id, @manifestation_types.collect{|m| [m.display_name.localize, m.id]}) -%>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.jpn_or_foreign') %>
    <%= f.select :jpn_or_foreign, Manifestation::JPN_OR_FOREIGN, :include_blank => true %>
  </div>

  <div class="field" id="frequency_field">
    <%= f.label t('activerecord.models.frequency') -%>
    <%= f.select(:frequency_id, @frequencies.collect{|frequency| [frequency.display_name.localize, frequency.id]}) -%>
  </div>

  <div class="field">
    <%= f.label :pub_date, :class => 'pub_date' -%>
    <%= f.text_field :pub_date, :class => 'date_field', :placeholder => "#{t('page.example')}: 2011, 2011-04-12"-%>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.country_of_publication') -%>
    <%= f.select(:country_of_publication_id, @countries.collect{|country| [country.display_name.localize, country.id]}) -%>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.place_of_publication') -%>
    <%= f.text_field :place_of_publication %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.models.language') -%>
    <%= f.select(:language_id, @languages.collect{|language| [language.display_name.localize, language.id]}) -%>
  </div>

  <%- if @manifestation.series_statement -%>
    <%= render :partial => 'manifestations/serial_form', :locals => {:f => f, :manifestation => @manifestation} -%>
  <%- else -%>
    <div class="field">
      <%= f.label :edition_display_value -%>
      <%= f.text_field :edition_display_value, :size=>"10" -%>
      <%= f.label :volume_number_string -%>
      <%= f.text_field :volume_number_string, :size=>"10" -%>
      <%= f.label :issue_number_string -%>
      <%= f.text_field :issue_number_string, :size=>"10" -%>
    </div>

    <div class="field">
      <%= f.label :isbn -%>
      <%= f.text_field :isbn, :class => 'resource_isbn_issn', :style => 'ime-mode: disabled' -%>
      <%= link_to_function t('activerecord.attributes.manifestation.wrong_isbn'), "$('#manifestation_wrong_isbn').toggle()" -%>
      <%= f.text_field :wrong_isbn, :class => 'resource_isbn_issn', :style => 'ime-mode: disabled; display: none' -%>
    </div>
    <div class="field">
      <%= f.label :lccn -%>
      <%= f.text_field :lccn, :class => 'resource_isbn_issn', :style => 'ime-mode: disabled' -%>
    </div>
    <div class="field">
      <%= f.label :marc_number -%>
      <%= f.text_field :marc_number, :class => 'resource_isbn_issn', :style => 'ime-mode: disabled' -%>
    </div>
    <div class="field">
      <%= f.label :ndc -%>
      <%= f.text_field :ndc, :class => 'resource_isbn_issn', :style => 'ime-mode: disabled' -%>
    </div>
  <%- end -%>

  <div class="field">
    <%= f.label :start_page -%>
    <%= f.text_field :start_page, :class => 'resource_integer' -%>
    <%= f.label :end_page -%>
    <%= f.text_field :end_page, :class => 'resource_integer' -%>
  </div>

  <div class="field">
    <%= f.label :height -%>(cm)
    <%= f.text_field :height, :class => 'resource_integer' -%>
    <%= f.label :width -%>(cm)
    <%= f.text_field :width, :class => 'resource_integer' -%>
    <%= f.label :depth -%>(cm)
    <%= f.text_field :depth, :class => 'resource_integer' -%>
  </div>

  <div class="field">
    <%= f.label :price -%>
    <%= f.text_field :price, :class => 'resource_integer' -%>
  </div>

  <div class="field">
    <%= f.label :access_address -%><br />
    <%= f.url_field :access_address, :class => 'resource_url' -%>
  </div>

  <div class="field">
    <%= f.label :repository_content -%>
    <%= f.check_box :repository_content -%>
  </div>

  <div class="field">
    <%= f.label t('role.required_role') -%>
    <%= f.select(:required_role_id, @roles.collect{|r| [r.display_name.localize, r.id]}) -%>
  </div>

  <div class="field">
    <%= f.label :except_recent -%>
    <%= f.check_box :except_recent -%>
  </div>

  <div class="field">
    <%= f.label :description -%><br />
    <%= f.text_area :description, :class => 'resource_textarea' -%>
  </div>

  <div class="field">
    <%= f.label :supplement -%><br />
    <%= f.text_area :supplement, :class => 'resource_textarea' -%>
  </div>

  <div class="field">
    <%= f.label :note -%><br />
    <%= f.text_area :note, :class => 'resource_textarea' -%>
  </div>

  <div class="field">
    <%= f.label :subject -%><%= t('manifestation.delim_semicolon') -%><br />
    <%= f.text_field :subject, :value => @subject -%>
  </div>
  <div class="field">
    <strong><%= t('manifestation.subject_transcription') -%></strong><%= t('manifestation.delim_semicolon') -%><br />
    <%= f.text_field :subject_transcription, :value => @subject_transcription, :class => 'resource_url' -%>
  </div>

  <div class="field">
    <strong><%= t('activerecord.models.theme') -%></strong><br />
    <%= f.text_field :theme, :id => 'manifestation_theme', :value => @keep_themes %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.missing_issue') -%>
    <%= f.select :missing_issue, missing_issue_statuses, :include_blank => true -%>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.acceptance_number') %>
    <%= f.text_field :acceptance_number, :class => "resource_integer" %>
  </div>

<% if false %> 
  <%#= TODO for exinfo: change property_name(=> exinfo1) when use this form. %>
  <div class="field">
    <label>exinfo</label><br /> 
    <%= text_field :exinfos, :exinfo1, :value => @exinfo1, :class => "" %>
  </div>
  <%#= TODO for extext: change property_name(=> extext1) when use this form. %>
  <div class="field">
    <label>extext</label><br /> 
    <%= text_field :extexts, :extext1, :value => @extext1, :class => "" %>
  </div>
<% end %>
<!--
  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_2') %>
    <%= f.text_field :exinfo_2, :class => "resource_integer" %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_3') %>
    <%= f.text_field :exinfo_3, :class => "resource_integer" %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_4') %>
    <%= f.text_field :exinfo_4, :class => "resource_integer" %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_5') %>
    <%= f.text_field :exinfo_5, :class => "resource_integer" %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_6') %>
    <%= f.text_field :exinfo_6, :class => "resource_integer" %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_7') %>
    <%= f.text_field :exinfo_7, :class => "resource_integer" %>
  </div>

  <div class="field">
    <%= f.label t('activerecord.attributes.manifestation.exinfo_8') %>
    <%= f.text_field :exinfo_8, :class => "resource_integer" %>
  </div>
-->

  <div class="actions">
    <%= hidden_field_tag :patron_id, @patron.id if @patron -%>
    <%= hidden_field_tag :manifestation_id, @original_manifestation.id if @original_manifestation -%>
    <%= hidden_field_tag :creators, @creators if @creators -%>
    <%= hidden_field_tag :contributors, @contributors if @contributors -%>
    <%= hidden_field_tag :publishers, @publishers if @publishers -%>
    <%= hidden_field_tag :subjects, @subjects if @subjects -%>
    <%= f.submit :disable_with => t('page.wait') %>
  </div>
  <%= javascript_tag("$('#manifestation_original_title').focus()") -%>
<%- end -%>
