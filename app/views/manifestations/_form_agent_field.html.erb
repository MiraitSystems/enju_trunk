<script>
  var addItemKeyCode = 122; // F11
  var removeItemKeyCode = 123; // F12
  
  var newAgentSlect2options = {
    multiple: false,
    minimumInputLength: 1,
    width: "250px",
    placeholder: <%= raw t("agent.search_placeholder").to_json %>,
    formatNoMatches: function(term) {
      return "'" + term + "' " + <%= raw t("agent.search_nomatch").to_json %>;
    },
    formatSearching: function() {
      return <%= raw t("agent.search_searching").to_json %>;
    },
    formatInputTooShort: function(term, minLength){
      return <%= raw t("agent.search_placeholder").to_json %>;
    },
    ajax: {
      url: "/agents/search_name.json",
      dataType: 'json',
      data: function (term, page) {
          return {search_phrase: term,
          };
      },
      results: function (data, page) {
          return {results: data};
      },
    },
    initSelection: function(element, callback) {
      var id = $(element).val();
      if (id != "" && id == parseInt(id)) {
        $.ajax("/agents/search_name.json?agent_id=" + id, {
            dataType: "json"
       }).done(function(data) { callback(data); });
      }
      else{
        callback({ id: id, text: id });
      }
    },
    createSearchChoice: function(term, data) {
      if ($(data).filter(function() {
        return this.text.localeCompare(term)===0; }).length===0) {
        return {id:term, text:term};
      }
    },
  };

  var agentTypeSlect2options = {
    width: "250px",
    matcher: function(term, text, opt) {
      return text.toUpperCase().indexOf(term.toUpperCase())==0
          || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())==0;
    }
  };

  $(document).ready(function() {
    $("#select2_creator,#select2_contributor,#select2_publisher").select2({
      multiple: false,
      minimumInputLength: 1,
      width: "250px",
      placeholder: <%= raw t("agent.search_placeholder").to_json %>,
      formatNoMatches: function(term) {
        return "'" + term + "' " + <%= raw t("agent.search_nomatch").to_json %>;
      },
      formatSearching: function() {
        return <%= raw t("agent.search_searching").to_json %>;
      },
      formatInputTooShort: function(term, minLength){
        return <%= raw t("agent.search_placeholder").to_json %>;
      },
      ajax: {
        url: "/agents/search_name.json",
        dataType: 'json',
        data: function (term, page) {
            return {search_phrase: term,
            };
        },
        results: function (data, page) {
            return {results: data};
        },
      },
      initSelection: function(element, callback) {
        var id = $(element).val();
        if (id != "") {
          $.ajax("/agents/search_name.json?agent_id=" + id, {
              dataType: "json"
         }).done(function(data) { callback(data); });
        }
      },
    });
    $("#select2_new_creator, #select2_new_contributor, #select2_new_publisher").select2(newAgentSlect2options);
  });
  $(document).on("select2-selecting", "#select2_new_creator", function(e){
    var attribute_name = e.target.name
    var attribute_number = attribute_name.match(/\d+/);
    if(e.val == parseInt(e.val)){
        $("#creator_ids_" + attribute_number).val(e.object.id);
        $("#creator_full_names_" + attribute_number).val(e.object.text);
        $("#creator_full_name_transcriptions_" + attribute_number).val(e.object.full_name_transcription);
    }
    else{
        $("#creator_ids_" + attribute_number).val("");
        $("#creator_full_names_" + attribute_number).val(e.object.text);
    }
  });
  $(document).on("select2-selecting", "#select2_new_contributor", function(e){
    var attribute_name = e.target.name
    var attribute_number = attribute_name.match(/\d+/);
    if(e.val == parseInt(e.val)){
        $("#contributor_ids_" + attribute_number).val(e.object.id);
        $("#contributor_full_names_" + attribute_number).val(e.object.text);
        $("#contributor_full_name_transcriptions_" + attribute_number).val(e.object.full_name_transcription);
    }
    else{
        $("#contributor_ids_" + attribute_number).val("");
        $("#contributor_full_names_" + attribute_number).val(e.object.text);
    }
  });
  $(document).on("select2-selecting", "#select2_new_publisher", function(e){
    var attribute_name = e.target.name
    var attribute_number = attribute_name.match(/\d+/);
    if(e.val == parseInt(e.val)){
        $("#publisher_ids_" + attribute_number).val(e.object.id);
        $("#publisher_full_names_" + attribute_number).val(e.object.text);
        $("#publisher_full_name_transcriptions_" + attribute_number).val(e.object.full_name_transcription);
    }
    else{
        $("#publisher_ids_" + attribute_number).val("");
        $("#publisher_full_names_" + attribute_number).val(e.object.text);
    }
  });

  /**
   * select2 フィールドのファンクション対応(オープン時)
   * 
   */
   $(document).on("keydown", ".select2-input", function(e){
  
    var keyCode = e.keyCode;

    if(keyCode == addItemKeyCode || keyCode == removeItemKeyCode ){

      // creators
      $("input[name^='creator_agent_ids']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemField_creator.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("name").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemField_creator.remove(currentNumber);
            }
            return false;
          }
        }
      });
      $("input[name^='creator_ids']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemField_creator_select2.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("name").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemField_creator_select2.remove(currentNumber);
            }
            return false;
          }
        }
      });

      // contributors
      $("input[name^='contributor_agent_ids']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemField_contributor.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("name").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemField_contributor.remove(currentNumber);
            }
            return false;
          }
        }
      });
      $("input[name^='contributor_ids']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemField_contributor_select2.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("name").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemField_contributor_select2.remove(currentNumber);
            }
            return false;
          }
        }
      });

      // publishers
      $("input[name^='publisher_agent_ids']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemField_publisher.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("name").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemField_publisher.remove(currentNumber);
            }
            return false;
          }
        }
      });
      $("input[name^='publisher_ids']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemField_publisher_select2.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("name").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemField_publisher_select2.remove(currentNumber);
            }
            return false;
          }
        }
      });

      // subjects
      $("input[name^='add_subjects']").each(function(){
        if($(this).select2('isFocused') == true){
          if(keyCode == addItemKeyCode){
            ItemFieldSubjectSelect2.add();
            return false;
          }
          if(keyCode == removeItemKeyCode){
            var currentNumber = $(this).attr("id").match(/\d+/);
            if(currentNumber != "0"){
              $(this).select2('close');
              ItemFieldSubjectSelect2.remove(currentNumber);
            }
            return false;
          }
        }
      });

    }
    
  });

  /**
   * select2 フィールドのファンクション対応(クローズ時)
   * 
   */
  $(document).on("keydown", "input[id^='s2id_autogen']", function(e){

    var keyCode = e.keyCode;

    if(keyCode == addItemKeyCode || keyCode == removeItemKeyCode ){
      var parentElement = e.target.parentElement;
      var nextElement = parentElement.nextElementSibling;
      if(keyCode == addItemKeyCode){
        if(nextElement.id == "select2_creator") ItemField_creator_select2.add();
        if(nextElement.id == "select2_new_creator") ItemField_creator.add();
        if(nextElement.id == "select2_contributor") ItemField_contributor_select2.add();
        if(nextElement.id == "select2_new_contributor") ItemField_contributor.add();
        if(nextElement.id == "select2_publisher") ItemField_publisher_select2.add();
        if(nextElement.id == "select2_new_publisher") ItemField_publisher.add();
        if(nextElement.id.indexOf("add_subjects") != -1) ItemFieldSubjectSelect2.add();
        return false;
      }
      if(keyCode == removeItemKeyCode){
        if(nextElement.id.indexOf("add_subjects") != -1){
          var currentNumber = nextElement.id.match(/\d+/);
        }
        else{
          var currentNumber = nextElement.name.match(/\d+/);
        }
        if(currentNumber != "0"){
          if(nextElement.id == "select2_creator") ItemField_creator_select2.remove(currentNumber);
          if(nextElement.id == "select2_new_creator") ItemField_creator.remove(currentNumber);
          if(nextElement.id == "select2_contributor") ItemField_contributor_select2.remove(currentNumber);
          if(nextElement.id == "select2_new_contributor") ItemField_contributor.remove(currentNumber);
          if(nextElement.id == "select2_publisher") ItemField_publisher_select2.remove(currentNumber);
          if(nextElement.id == "select2_new_publisher") ItemField_publisher.remove(currentNumber);
          if(nextElement.id.indexOf("add_subjects") != -1) ItemFieldSubjectSelect2.remove(currentNumber);
         }
        return false;
      }
     }

   });

  /**
   * 件名読み フィールドのファンクション対応
   * 
   */
  $(document).on("keydown", "input[id$='term_transcription']", function(e){
  
    var keyCode = e.keyCode;

    if(keyCode == addItemKeyCode || keyCode == removeItemKeyCode ){
      if(keyCode == addItemKeyCode){
        ItemFieldSubjectSelect2.add();
        return false;
      }
      if(keyCode == removeItemKeyCode){
        var currentNumber = e.target.id.match(/\d+/);
        if(currentNumber != "0"){
          $(e.target).select2('close');
          ItemFieldSubjectSelect2.remove(currentNumber);
        }
        return false;
      }
     }

   });

</script>
<% if SystemConfiguration.get("add_only_exist_agent") %>
  <% select2_str = '_select2' %>
  <%= text_field :select2_agent, :id, :id => 'select2_hidden', :style => 'display: none;' %>
<% end %>

<% if SystemConfiguration.get("use_agent_type") %>
  <select id="select2_creator_types_hidden" style="display: none;">
    <%= raw @create_types.collect{ |r| ["<option alt='" + r.name + "', value='" + r.id.to_s + "'>" + r.display_name.localize + " (" + r.name + ")</option>"] } %>
  </select>
<% end %>
<script>
  var ItemField_creator = {
    currentNumber : <%= raw (@add_creators.blank? ? 1 : @add_creators.size).to_json %>,
    itemTemplate : ''
      + '<td><input type="button" value="+" onClick="ItemField_creator.add();" /></td>'
      + '<td><input type="button" value="-" onClick="ItemField_creator.remove(__count__);" /></td>',
    add : function () {
      var $new_field = $("<tr/>").attr("id", "CF" + this.currentNumber);

      var $clone = $('input[name="creator_agent_ids[0]"]').clone();
      $clone.attr('name','creator_agent_ids[' + this.currentNumber + ']');
      $clone.val('');

      var $creator_ids_clone = $("#creator_ids_0").clone();
      $creator_ids_clone.attr('id', 'creator_ids_' + this.currentNumber);
      $creator_ids_clone.attr('name', 'creator_ids[' + this.currentNumber + ']');
      $creator_ids_clone.attr('value', "");

      var $creator_full_names_clone = $("#creator_full_names_0").clone();
      $creator_full_names_clone.attr('id', 'creator_full_names_' + this.currentNumber);
      $creator_full_names_clone.attr('name', 'creator_full_names[' + this.currentNumber + ']');
      $creator_full_names_clone.attr('value', "");
      
      var $clone_field = $("<td/>");
      $clone_field.append($clone);
      $clone.select2(newAgentSlect2options);
      $clone_field.append($creator_ids_clone);
      $clone_field.append($creator_full_names_clone);
      $new_field.append($clone_field);

      var $creator_full_name_transcriptions_clone = $("#creator_full_name_transcriptions_0").clone();
      $creator_full_name_transcriptions_clone.attr('id', 'creator_full_name_transcriptions_' + this.currentNumber);
      $creator_full_name_transcriptions_clone.attr('name', 'creator_full_name_transcriptions[' + this.currentNumber + ']');
      $creator_full_name_transcriptions_clone.val("");
      var $creator_full_name_transcriptions_clone_field = $("<td/>");
      $creator_full_name_transcriptions_clone_field.append($creator_full_name_transcriptions_clone);
      $new_field.append($creator_full_name_transcriptions_clone_field);

      <% if SystemConfiguration.get("use_agent_type") %>
        var $creator_types_clone = $("#creator_type_ids_0").clone();
        $creator_types_clone.attr('id', 'creator_type_ids_' + this.currentNumber);
        $creator_types_clone.attr('name', 'creator_type_ids[' + this.currentNumber + ']');
        var $creator_types_clone_field = $("<td/>");
        $creator_types_clone_field.append($creator_types_clone);
        $creator_types_clone.select2(agentTypeSlect2options);
        $new_field.append($creator_types_clone_field);
      <% end %>
      
      var newItem = this.itemTemplate.replace(/__count__/mg, this.currentNumber);
      $new_field.append(newItem);
      $("#creator_field > table > tbody").append($new_field);
      this.currentNumber += 1;
    },
    remove : function (div_num) {
      var field = document.getElementById('CF' + div_num);
      if(field != null){ field.parentNode.removeChild(field); }
    }
  }
  var ItemField_creator_select2 = {
    currentNumber : <%= raw (@add_creators.blank? ? 1 : @add_creators.size).to_json %>,
    itemTemplate : ''
//      <% if SystemConfiguration.get("use_agent_type") %>
//        + '<td><select id="creator_type_ids___count__" name="creator_type_ids[__count__]">'
//        + <%= raw @create_types.collect{ |t| ["<option value='" + t.id.to_s + "'>" + t.display_name.localize + "</option>"] }.to_json %>
//        + '</select></td>'
//      <% end %>
      + '<td><input type="button" value="+" onClick="ItemField_creator_select2.add();" /></td>'
      + '<td><input type="button" value="-" onClick="ItemField_creator_select2.remove(__count__);" /></td>',
    add : function () {
      var $clone = $("#select2_hidden").clone();
      $clone[0].id = 'select2_creator';
      $clone.show();
      $clone.attr('name','creator_ids[' + this.currentNumber + ']');

      <% if SystemConfiguration.get("use_agent_type") %>
        var $creator_types_clone = $("#select2_creator_types_hidden").clone();
        $creator_types_clone[0].id = 'select2_creator_types';
        $creator_types_clone.show();
        $creator_types_clone.attr('name', 'creator_type_ids[' + this.currentNumber + ']');
        var $creator_types_clone_field = $("<td/>");
        $creator_types_clone_field.append($creator_types_clone);
      <% end %>

      var $new_field = $("<tr/>").attr("id", "CF" + this.currentNumber);
      var newItem = this.itemTemplate.replace(/__count__/mg, this.currentNumber);
      var $clone_field = $("<td/>");
      $clone_field.append($clone);
      $new_field.append($clone_field);

      <% if SystemConfiguration.get("use_agent_type") %>
        $new_field.append($creator_types_clone_field);
      <% end %>

      $new_field.append(newItem);
      $("#creator_field > table > tbody").append($new_field);
      this.currentNumber += 1;
      $clone.select2({
        multiple: false,
        width: "250px",
        minimumInputLength: 1,
        placeholder: <%= raw t("agent.search_placeholder").to_json %>,
        formatNoMatches: function(term) {
          return "'" + term + "' " + <%= raw t("agent.search_nomatch").to_json %>;
        },
        formatSearching: function() {
          return <%= raw t("agent.search_searching").to_json %>;
        },
        formatInputTooShort: function(term, minLength){
          return <%= raw t("agent.search_placeholder").to_json %>;
        },
        ajax: {
          url: "/agents/search_name.json",
          dataType: 'json',
          data: function (term, page) {
            return {search_phrase: term,
            };
          },
          results: function (data, page) {
            return {results: data};
          },
        },
      });

      <% if SystemConfiguration.get("use_agent_type") %>
        $creator_types_clone.select2({
          width: "250px",
          matcher: function(term, text, opt) {
            return text.toUpperCase().indexOf(term.toUpperCase())==0
                || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())==0;
          }
        });
      <% end %>

    },
    remove : function (div_num) {
      var field = document.getElementById('CF' + div_num);
      if(field != null){ field.parentNode.removeChild(field); }
    }
  }
</script>

<div class="field">
  <strong><%= t('agent.creator') %></strong><br />
  <table id="bless">
  <% @creates.each_with_index do |create, i| %>
    <tr>
    <td><%= link_to create.agent.full_name, agent_path(create.agent_id), :target => ["_blank"] -%></td>
    <% if SystemConfiguration.get("use_agent_type") %>
      <td>
        <%#= select_tag "creates[#{create.agent_id}]",
            options_for_select(@create_types.collect{ |r| [r.display_name.localize, r.id] },
            :selected => create.create_type_id) %>
        <%= select2_script "creates_#{ create.agent_id }" %>
        <%= make_select2(
          "creates_#{ create.agent_id }", 
          "creates[#{ create.agent_id }]", 
          @create_types,
          create.create_type_id, 
          250, 
        ) %>
      </td>
    <% else %>
      <%= hidden_field_tag "creates[#{create.agent_id}]" %>
    <% end %>
    <td>
      <%= t('page.destroy') %>
      <%= check_box_tag 'del_creator_ids[]', create.agent_id.to_s, @del_creators.include?(create.agent_id.to_s), {} -%>
    </td>
    </tr>
  <% end %>
  </table>
</div>
<div id="creator_field" class="field">
  <table id="bless">
  <% @add_creators.each_with_index do |creator, i| %>
    <tr id="CF<%= i.to_s %>" >
      <% if SystemConfiguration.get("add_only_exist_agent") %>
        <td><%= text_field :creator_ids, i, :id => 'select2_creator', :value => creator[:agent_id] %></td>
      <% else %>
        <td>
          <%= text_field_tag "creator_agent_ids[#{i}]", (@add_creator_agent_ids.blank? ? nil : @add_creator_agent_ids[i.to_s]), :id => 'select2_new_creator', :placeholder => t("activerecord.attributes.agent.full_name") %>
          <%= hidden_field_tag "creator_ids[#{i}]", creator[:agent_id] %>
          <%= hidden_field_tag "creator_full_names[#{i}]", creator[:full_name] %>
        </td>
        <td>
          <%= text_field_tag "creator_full_name_transcriptions[#{i}]", creator[:full_name_transcription],
            :placeholder => t("activerecord.attributes.agent.full_name_transcription") %>
        </td>
      <% end %>
      <% if SystemConfiguration.get("use_agent_type") %>
        <td>
        <%#= select_tag "creator_type_ids[#{i}]",
          options_for_select(@create_types.collect{ |r| [r.display_name.localize, r.id] }, :selected => creator[:type_id]) %>
        <%= select2_script "creator_type_ids_#{i}" %>
        <%= make_select2(
          "creator_type_ids_#{i}", 
          "creator_type_ids[#{i}]", 
          @create_types,
          creator[:type_id], 
          250, 
        ) %>
        </td>
      <% end %>
      <td><%= button_to_function t('page.add_line'), "ItemField_creator#{select2_str}.add()" -%></td>
      <td><%= button_to_function t('page.del_line'), "ItemField_creator#{select2_str}.remove(#{i})" if i > 0 -%></td>
    </tr>
  <% end %>
  </table>
</div>

<% if SystemConfiguration.get("use_agent_type") %>
  <select id="select2_contributor_types_hidden" style="display: none;">
    <%= raw @realize_types.collect{ |r| ["<option alt='" + r.name + "', value='" + r.id.to_s + "'>" + r.display_name.localize + " (" + r.name + ")</option>"] } %>
  </select>
<% end %>
<script>
  var ItemField_contributor = {
    currentNumber : <%= raw (@add_contributors.blank? ? 1 : @add_contributors.size).to_json %>,
    itemTemplate : ''
      + '<td><input type="button" value="+" onClick="ItemField_contributor.add();" /></td>'
      + '<td><input type="button" value="-" onClick="ItemField_contributor.remove(__count__);" /></td>',
    add : function () {
      var $new_field = $("<tr/>").attr("id", "RF" + this.currentNumber);

      var $clone = $('input[name="contributor_agent_ids[0]"]').clone();
      $clone.attr('name','contributor_agent_ids[' + this.currentNumber + ']');
      $clone.val('');

      var $contributor_ids_clone = $("#contributor_ids_0").clone();
      $contributor_ids_clone.attr('id', 'contributor_ids_' + this.currentNumber);
      $contributor_ids_clone.attr('name', 'contributor_ids[' + this.currentNumber + ']');
      $contributor_ids_clone.attr('value', "");

      var $contributor_full_names_clone = $("#contributor_full_names_0").clone();
      $contributor_full_names_clone.attr('id', 'contributor_full_names_' + this.currentNumber);
      $contributor_full_names_clone.attr('name', 'contributor_full_names[' + this.currentNumber + ']');
      $contributor_full_names_clone.attr('value', "");
      
      var $clone_field = $("<td/>");
      $clone_field.append($clone);
      $clone.select2(newAgentSlect2options);
      $clone_field.append($contributor_ids_clone);
      $clone_field.append($contributor_full_names_clone);
      $new_field.append($clone_field);

      var $contributor_full_name_transcriptions_clone = $("#contributor_full_name_transcriptions_0").clone();
      $contributor_full_name_transcriptions_clone.attr('id', 'contributor_full_name_transcriptions_' + this.currentNumber);
      $contributor_full_name_transcriptions_clone.attr('name', 'contributor_full_name_transcriptions[' + this.currentNumber + ']');
      $contributor_full_name_transcriptions_clone.val("");
      var $contributor_full_name_transcriptions_clone_field = $("<td/>");
      $contributor_full_name_transcriptions_clone_field.append($contributor_full_name_transcriptions_clone);
      $new_field.append($contributor_full_name_transcriptions_clone_field);

      <% if SystemConfiguration.get("use_agent_type") %>
        var $contributor_types_clone = $("#contributor_type_ids_0").clone();
        $contributor_types_clone.attr('id', 'contributor_type_ids_' + this.currentNumber);
        $contributor_types_clone.attr('name', 'contributor_type_ids[' + this.currentNumber + ']');
        var $contributor_types_clone_field = $("<td/>");
        $contributor_types_clone_field.append($contributor_types_clone);
        $contributor_types_clone.select2(agentTypeSlect2options);
        $new_field.append($contributor_types_clone_field);
      <% end %>
      
      var newItem = this.itemTemplate.replace(/__count__/mg, this.currentNumber);
      $new_field.append(newItem);
      $("#contributor_field > table > tbody").append($new_field);
      this.currentNumber += 1;
    },
    remove : function (div_num) {
      var field = document.getElementById('RF' + div_num);
      if(field != null){ field.parentNode.removeChild(field); }
    }
  }

  var ItemField_contributor_select2 = {
    currentNumber : <%= raw (@add_contributors.blank? ? 1 : @add_contributors.size).to_json %>,
    itemTemplate : ''
//      <% if SystemConfiguration.get("use_agent_type") %>
//        + '<td><select id="contributor_type_ids___count__" name="contributor_type_ids[__count__]">'
//        + <%= raw @realize_types.collect{ |t| ["<option value='" + t.id.to_s + "'>" + t.display_name.localize + "</option>"] }.to_json %>
//        + '</select></td>'
//      <% end %>
      + '<td><input type="button" value="+" onClick="ItemField_contributor_select2.add();" /></td>'
      + '<td><input type="button" value="-" onClick="ItemField_contributor_select2.remove(__count__);" /></td>',
    add : function () {
      var $clone = $("#select2_hidden").clone();
      $clone[0].id = 'select2_contributor';
      $clone.show();
      $clone.attr('name','contributor_ids[' + this.currentNumber + ']');
      var $contributor_types_clone = $("#select2_contributor_types_hidden").clone();

      <% if SystemConfiguration.get("use_agent_type") %>
        $contributor_types_clone[0].id = 'select2_contributor_types';
        $contributor_types_clone.show();
        $contributor_types_clone.attr('name','contributor_type_ids[' + this.currentNumber + ']');
        var $contributor_types_clone_field = $("<td/>");
        $contributor_types_clone_field.append($contributor_types_clone);
      <% end %>

      var $new_field = $("<tr/>").attr("id", "RF" + this.currentNumber);
      var newItem = this.itemTemplate.replace(/__count__/mg, this.currentNumber);
      var $clone_field = $("<td/>");
      $clone_field.append($clone);
      $new_field.append($clone_field);

      <% if SystemConfiguration.get("use_agent_type") %>
        $new_field.append($contributor_types_clone_field);
      <% end %>

      $new_field.append(newItem);
      $("#contributor_field > table > tbody").append($new_field);
      this.currentNumber += 1;
      $clone.select2({
        multiple: false,
        width: "250px",
        minimumInputLength: 1,
        placeholder: <%= raw t("agent.search_placeholder").to_json %>,
        formatNoMatches: function(term) {
          return "'" + term + "' " + <%= raw t("agent.search_nomatch").to_json %>;
        },
        formatSearching: function() {
          return <%= raw t("agent.search_searching").to_json %>;
        },
        formatInputTooShort: function(term, minLength){
          return <%= raw t("agent.search_placeholder").to_json %>;
        },
        ajax: {
          url: "/agents/search_name.json",
          dataType: 'json',
          data: function (term, page) {
            return {search_phrase: term,
            };
          },
          results: function (data, page) {
            return {results: data};
          },
        },
      });
      <% if SystemConfiguration.get("use_agent_type") %>
        $contributor_types_clone.select2({
          width: "250px",
          matcher: function(term, text, opt) {
            return text.toUpperCase().indexOf(term.toUpperCase())==0
                || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())==0;
          }
        });
      <% end %>
    },
    remove : function (div_num) {
      var field = document.getElementById('RF' + div_num);
      if(field != null){ field.parentNode.removeChild(field); }
    }
  }
</script>

<div class="field">
  <strong><%= t('agent.contributor') %></strong><br />
  <table id="bless">
  <% @realizes.each_with_index do |realize, i| %>
    <tr>
    <td><%= link_to realize.agent.full_name, agent_path(realize.agent_id), :target => ["_blank"] -%></td>
    <% if SystemConfiguration.get("use_agent_type") %>
      <td>
        <%#= select_tag "realizes[#{realize.agent_id}]",
            options_for_select(@realize_types.collect{ |r| [r.display_name.localize, r.id] },
            :selected => realize.realize_type_id) %>
        <%= select2_script "realizes_#{ realize.agent_id }" %>
        <%= make_select2(
          "realizes_#{ realize.agent_id }", 
          "realizes[#{ realize.agent_id }]", 
          @realize_types,
          realize.realize_type_id, 
          250, 
        ) %>
      </td>
    <% else %>
      <%= hidden_field_tag "realizes[#{realize.agent_id}]" %>
    <% end %>
    <td>
      <%= t('page.destroy') %>
      <%= check_box_tag 'del_contributor_ids[]', realize.agent_id.to_s, @del_contributors.include?(realize.agent_id.to_s), {} -%>
    </td>
    </tr>
  <% end %>
  </table>
</div>
<div id="contributor_field" class="field">
  <table id="bless">
  <% @add_contributors.each_with_index do |contributor, i| %>
    <tr id="RF<%= i.to_s %>" >
      <% if SystemConfiguration.get("add_only_exist_agent") %>
        <td><%= text_field :contributor_ids, i, :id => 'select2_contributor', :value => contributor[:agent_id] %></td>
      <% else %>
        <td>
          <%= text_field_tag "contributor_agent_ids[#{i}]", (@add_contributor_agent_ids.blank? ? nil : @add_contributor_agent_ids[i.to_s]), :id => 'select2_new_contributor', :placeholder => t("activerecord.attributes.agent.full_name") %>
          <%= hidden_field_tag "contributor_ids[#{i}]", contributor[:agent_id] %>
          <%= hidden_field_tag "contributor_full_names[#{i}]", contributor[:full_name] %>
        </td>
        <td>
          <%= text_field_tag "contributor_full_name_transcriptions[#{i}]", contributor[:full_name_transcription],
            :placeholder => t("activerecord.attributes.agent.full_name_transcription") %>
        </td>
      <% end %>
      <% if SystemConfiguration.get("use_agent_type") %>
        <td>
        <%#= select_tag "contributor_type_ids[#{i}]",
          options_for_select(@realize_types.collect{ |r| [r.display_name.localize, r.id] }, :selected => contributor[:type_id]) %>
        <%= select2_script "contributor_type_ids_#{i}" %>
        <%= make_select2(
          "contributor_type_ids_#{i}", 
          "contributor_type_ids[#{i}]", 
          @realize_types,
          contributor[:type_id], 
          250, 
        ) %>
        </td>
      <% end %>
      <td><%= button_to_function t('page.add_line'), "ItemField_contributor#{select2_str}.add()" -%></td>
      <td><%= button_to_function t('page.del_line'), "ItemField_contributor#{select2_str}.remove(#{i})" if i > 0 -%></td>
    </tr>
  <% end %>
  </table>
</div>

<% if SystemConfiguration.get("use_agent_type") %>
  <select id="select2_publisher_types_hidden" style="display: none;">
    <%= raw @produce_types.collect{ |r| ["<option alt='" + r.name + "', value='" + r.id.to_s + "'>" + r.display_name.localize + " (" + r.name + ")</option>"] } %>
  </select>
<% end %>
<script>
  var ItemField_publisher = {
    currentNumber : <%= raw (@add_publishers.blank? ? 1 : @add_publishers.size).to_json %>,
    itemTemplate : ''
      + '<td><input type="button" value="+" onClick="ItemField_publisher.add();" /></td>'
      + '<td><input type="button" value="-" onClick="ItemField_publisher.remove(__count__);" /></td>',
    add : function () {
      var $new_field = $("<tr/>").attr("id", "PF" + this.currentNumber);

      var $clone = $('input[name="publisher_agent_ids[0]"]').clone();
      $clone.attr('name','publisher_agent_ids[' + this.currentNumber + ']');
      $clone.val('');

      var $publisher_ids_clone = $("#publisher_ids_0").clone();
      $publisher_ids_clone.attr('id', 'publisher_ids_' + this.currentNumber);
      $publisher_ids_clone.attr('name', 'publisher_ids[' + this.currentNumber + ']');
      $publisher_ids_clone.attr('value', "");

      var $publisher_full_names_clone = $("#publisher_full_names_0").clone();
      $publisher_full_names_clone.attr('id', 'publisher_full_names_' + this.currentNumber);
      $publisher_full_names_clone.attr('name', 'publisher_full_names[' + this.currentNumber + ']');
      $publisher_full_names_clone.attr('value', "");
      
      var $clone_field = $("<td/>");
      $clone_field.append($clone);
      $clone.select2(newAgentSlect2options);
      $clone_field.append($publisher_ids_clone);
      $clone_field.append($publisher_full_names_clone);
      $new_field.append($clone_field);

      var $publisher_full_name_transcriptions_clone = $("#publisher_full_name_transcriptions_0").clone();
      $publisher_full_name_transcriptions_clone.attr('id', 'publisher_full_name_transcriptions_' + this.currentNumber);
      $publisher_full_name_transcriptions_clone.attr('name', 'publisher_full_name_transcriptions[' + this.currentNumber + ']');
      $publisher_full_name_transcriptions_clone.val("");
      var $publisher_full_name_transcriptions_clone_field = $("<td/>");
      $publisher_full_name_transcriptions_clone_field.append($publisher_full_name_transcriptions_clone);
      $new_field.append($publisher_full_name_transcriptions_clone_field);

      <% if SystemConfiguration.get("use_agent_type") %>
        var $publisher_types_clone = $("#publisher_type_ids_0").clone();
        $publisher_types_clone.attr('id', 'publisher_type_ids_' + this.currentNumber);
        $publisher_types_clone.attr('name', 'publisher_type_ids[' + this.currentNumber + ']');
        var $publisher_types_clone_field = $("<td/>");
        $publisher_types_clone_field.append($publisher_types_clone);
        $publisher_types_clone.select2(agentTypeSlect2options);
        $new_field.append($publisher_types_clone_field);
      <% end %>
      
      var newItem = this.itemTemplate.replace(/__count__/mg, this.currentNumber);
      $new_field.append(newItem);
      $("#publisher_field > table > tbody").append($new_field);
      this.currentNumber += 1;
    },
    remove : function (div_num) {
      var field = document.getElementById('PF' + div_num);
      if(field != null){ field.parentNode.removeChild(field); }
    }
  }
  var ItemField_publisher_select2 = {
    currentNumber : <%= raw (@add_publishers.blank? ? 1 : @add_publishers.size).to_json %>,
    itemTemplate : ''
//      <% if SystemConfiguration.get("use_agent_type") %>
//        + '<td><select id="publisher_type_ids___count__" name="publisher_type_ids[__count__]">'
//        + <%= raw @produce_types.collect{ |t| ["<option value='" + t.id.to_s + "'>" + t.display_name.localize + "</option>"] }.to_json %>
//        + '</select></td>'
//      <% end %>
      + '<td><input type="button" value="+" onClick="ItemField_publisher_select2.add();" /></td>'
      + '<td><input type="button" value="-" onClick="ItemField_publisher_select2.remove(__count__);" /></td>',
    add : function () {
      var $clone = $("#select2_hidden").clone();
      $clone[0].id = 'select2_publisher';
      $clone.show();
      $clone.attr('name','publisher_ids[' + this.currentNumber + ']');

      <% if SystemConfiguration.get("use_agent_type") %>
        var $publisher_types_clone = $("#select2_publisher_types_hidden").clone();
        $publisher_types_clone[0].id = 'select2_publisher_types';
        $publisher_types_clone.show();
        $publisher_types_clone.attr('name','publisher_type_ids[' + this.currentNumber + ']');
        var $publisher_types_clone_field = $("<td/>");
        $publisher_types_clone_field.append($publisher_types_clone);
      <% end %>

      var $new_field = $("<tr/>").attr("id", "PF" + this.currentNumber);
      var newItem = this.itemTemplate.replace(/__count__/mg, this.currentNumber);
      var $clone_field = $("<td/>");
      $clone_field.append($clone);
      $new_field.append($clone_field);

      <% if SystemConfiguration.get("use_agent_type") %>
        $new_field.append($publisher_types_clone_field);
      <% end %>

      $new_field.append(newItem);
      $("#publisher_field > table > tbody").append($new_field);
      this.currentNumber += 1;
      $clone.select2({
        multiple: false,
        width: "250px",
        minimumInputLength: 1,
        placeholder: <%= raw t("agent.search_placeholder").to_json %>,
        formatNoMatches: function(term) {
          return "'" + term + "' " + <%= raw t("agent.search_nomatch").to_json %>;
        },
        formatSearching: function() {
          return <%= raw t("agent.search_searching").to_json %>;
        },
        formatInputTooShort: function(term, minLength){
          return <%= raw t("agent.search_placeholder").to_json %>;
        },
        ajax: {
          url: "/agents/search_name.json",
          dataType: 'json',
          data: function (term, page) {
            return {search_phrase: term,
            };
          },
          results: function (data, page) {
            return {results: data};
          },
        },
      });
      <% if SystemConfiguration.get("use_agent_type") %>
        $publisher_types_clone.select2({
          width: "250px",
          matcher: function(term, text, opt) {
            return text.toUpperCase().indexOf(term.toUpperCase())==0
                || opt.attr("alt").toUpperCase().indexOf(term.toUpperCase())==0;
          }
        });
      <% end %>
    },
    remove : function (div_num) {
      var field = document.getElementById('PF' + div_num);
      if(field != null){ field.parentNode.removeChild(field); }
    }
  }
</script>

<div class="field">
  <strong><%= t('agent.publisher') %></strong><br />
  <table id="bless">
  <% @produces.each_with_index do |produce, i| %>
    <tr>
    <td><%= link_to produce.agent.full_name, agent_path(produce.agent_id), :target => ["_blank"] -%></td>
    <% if SystemConfiguration.get("use_agent_type") %>
      <td>
        <%#= select_tag "produces[#{produce.agent_id}]",
            options_for_select(@produce_types.collect{ |r| [r.display_name.localize, r.id] },
            :selected => produce.produce_type_id) %>
        <%= select2_script "produces_#{produce.agent_id}" %>
        <%= make_select2(
          "produces_#{produce.agent_id}", 
          "produces[#{produce.agent_id}]", 
          @produce_types,
          produce.produce_type_id, 
          250, 
        ) %>
      </td>
    <% else %>
      <%= hidden_field_tag "produces[#{produce.agent_id}]" %>
    <% end %>
    <td>
      <%= t('page.destroy') %>
      <%= check_box_tag 'del_publisher_ids[]', produce.agent_id.to_s, @del_publishers.include?(produce.agent_id.to_s), {} -%>
    </td>
    </tr>
  <% end %>
  </table>
</div>
<div id="publisher_field" class="field">
  <table id="bless">
  <% @add_publishers.each_with_index do |publisher, i| %>
    <tr id="PF<%= i.to_s %>" >
      <% if SystemConfiguration.get("add_only_exist_agent") %>
        <td><%= text_field :publisher_ids, i, :id => 'select2_publisher', :value => publisher[:agent_id] %></td>
      <% else %>
        <td>
          <%= text_field_tag "publisher_agent_ids[#{i}]", (@add_publisher_agent_ids.blank? ? nil : @add_publisher_agent_ids[i.to_s]), :id => 'select2_new_publisher', :placeholder => t("activerecord.attributes.agent.full_name") %>
          <%= hidden_field_tag "publisher_ids[#{i}]", publisher[:agent_id] %>
          <%= hidden_field_tag "publisher_full_names[#{i}]", publisher[:full_name] %>
        </td>
        <td>
          <%= text_field_tag "publisher_full_name_transcriptions[#{i}]", publisher[:full_name_transcription],
            :placeholder => t("activerecord.attributes.agent.full_name_transcription") %>
        </td>
      <% end %>
      <% if SystemConfiguration.get("use_agent_type") %>
        <td>
        <%#= select_tag "publisher_type_ids[#{i}]",
          options_for_select(@produce_types.collect{ |r| [r.display_name.localize, r.id] }, :selected => publisher[:type_id]) %>
        <%= select2_script "publisher_type_ids_#{i}" %>
        <%= make_select2(
          "publisher_type_ids_#{i}", 
          "publisher_type_ids[#{i}]", 
          @produce_types,
          publisher[:type_id], 
          250, 
        ) %>
        </td>
      <% end %>
      <td><%= button_to_function t('page.add_line'), "ItemField_publisher#{select2_str}.add()" -%></td>
      <td><%= button_to_function t('page.del_line'), "ItemField_publisher#{select2_str}.remove(#{i})" if i > 0 -%></td>
    </tr>
  <% end %>
  </table>
</div>
